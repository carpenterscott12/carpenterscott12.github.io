<!DOCTYPE html>

<head>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="stylesheet" type="text/css" href="spades.css" />
</head>

<body>

<div id="GameContainer">
    <div id="PlayArea">
        <div id="Player4Card" class="play-area-card"></div>
        <div id="Player3Card" class="play-area-card"></div>
        <div id="Player2Card" class="play-area-card"></div>
        <div id="Player1Card" class="play-area-card"></div>
    </div>
    <div id="PlayerCardsContainer">
        <input id="playerCard0" class="player-card" type="button"/>
        <input id="playerCard1" class="player-card" type="button"/>
        <input id="playerCard2" class="player-card" type="button"/>
        <input id="playerCard3" class="player-card" type="button"/>
        <input id="playerCard4" class="player-card" type="button"/>
        <input id="playerCard5" class="player-card" type="button"/>
        <input id="playerCard6" class="player-card" type="button"/>
        <input id="playerCard7" class="player-card" type="button"/>
        <input id="playerCard8" class="player-card" type="button"/>
        <input id="playerCard9" class="player-card" type="button"/>
        <input id="playerCard10" class="player-card" type="button"/>
        <input id="playerCard11" class="player-card" type="button"/>
        <input id="playerCard12" class="player-card" type="button"/>
    </div>
</div>

</body>
<style>

</style>

<script>

    // Globals
    let deck = null;
    let player1 = null;
    let player2 = null;
    let player3 = null;
    let player4 = null;
    let Player1CardDiv = null;
    let Player2CardDiv = null;
    let Player3CardDiv = null;
    let Player4CardDiv = null;
    let dealerIndex = null;
    let players = [player1, player2, player3, player4];

    let Player1CardInputs = [];

    // There should not be a reason to access index 0 or 1, but other indices correspond to card ranks in order of strength.
    const rankStrings = ["", "", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];

    const suitStrings = ["♠", "♥", "♦", "♣"];

    // Enums
    const Suit = {
        Spade: 0,
        Heart: 1,
        Diamond: 2,
        Club: 3
    }

    // Classes
    class HtmlDiv {
        constructor(divId, defaultInnerHtml) {
            this._divId = divId;
            this._element = document.getElementById(divId);
            this._element.innerHTML = defaultInnerHtml;
        }

        hide() {
            this._element.style.display = "none";
        }

        showBlock() {
            this._element.style.display = "block";
        }

        showInlineBlock() {
            this._element.style.display = "inline-block";
        }

        setInnerHtml(input) {
            this._element.innerHTML = input;
        }

        setColorRed() {
            this._element.style.color = "red";
        }

        setColorBlack() {
            this._element.style.color = "black";
        }
    }

    class HtmlInput {
        constructor(inputId, val) {
            this._inputId = inputId;
            this._element = document.getElementById(inputId);
            this._element.value = val;
        }

        hide() {
            this._element.style.display = "none";
        }

        showBlock() {
            this._element.style.display = "block";
        }

        showInlineBlock() {
            this._element.style.display = "inline-block";
        }

        setValue(val) {
            this._element.value = val;
        }

        setColorRed() {
            this._element.style.color = "red";
        }

        setColorBlack() {
            this._element.style.color = "black";
        }
    }

    class Card {
        constructor(rank, suit) {
            this._rank = rank;
            this._suit = suit;
            this._discarded = false;
        }

        discard() {
            this._discarded = true;
        }
    }

    class Deck {
        constructor() {
            this._cards = [];
            this.addAllRanksForSuit(Suit.Spade);
            this.addAllRanksForSuit(Suit.Heart);
            this.addAllRanksForSuit(Suit.Diamond);
            this.addAllRanksForSuit(Suit.Club);
            this.shuffle();
        }

        addAllRanksForSuit(suit) {
            let i = 0;
            for (i = 0; i < 13; i++) {
                let newCard = new Card(i + 2, suit);
                this._cards.push(newCard);
            }
        }

        shuffle() {
            for (let i = this._cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [this._cards[i], this._cards[j]] = [this._cards[j], this._cards[i]];
            }
        }

        draw() {
            if (this._cards.length > 0) {
                return this._cards.shift();
            }
            else {
                console.log("Deck was empty when trying to draw.");
                return null;
            }
        }
    }

    class Player {
        constructor(name) {
            this._name = name;
            this._spadesInHand = [];
            this._heartsInHand = [];
            this._diamondsInHand = [];
            this._clubsInHand = [];
        }

        addToHand(card) {
            switch (card._suit) {
                case Suit.Spade:
                    this._spadesInHand.push(card);
                    break;
                case Suit.Heart:
                    this._heartsInHand.push(card);
                    break;
                case Suit.Diamond:
                    this._diamondsInHand.push(card);
                    break;
                case Suit.Club:
                    this._clubsInHand.push(card);
                    break;
                default:
                    console.log("The suit was not valid.");
            }
        }

        drawFullHand() {
            if (deck !== null && deck._cards.length >= 13) {
                let i = 0;
                for (i = 0; i < 13; i++) {
                    this.addToHand(deck.draw());
                }
                this.sortByRank(this._spadesInHand);
                this.sortByRank(this._heartsInHand);
                this.sortByRank(this._diamondsInHand);
                this.sortByRank(this._clubsInHand);
            }
            else {
                console.log("The deck contained less than 13 cards when trying to deal a full hand.");
            }
        }

        getHandArray() {
            return this._heartsInHand.concat(this._clubsInHand.concat(this._diamondsInHand.concat(this._spadesInHand)));
        }

        sortByRank(suitList) {
            suitList.sort((a, b) => (a._rank > b._rank) ? 1 : -1);
        }

        getListString(suitList) {
            let result = "";
            let i = 0;
            for (i = 0; i < suitList.length; i++) {
                result += rankStrings[suitList[i]._rank] + suitStrings[suitList[i]._suit];
                if (i != suitList.length - 1) {
                    result += " ";
                }
                
            }
            return result;
        }

        setBid(bidAmount) {
            if (bidAmount < 0 || bidAmount > 13) {
                console.log("Bid amount was out of bounds: " + bidAmount);
            }
            else {
                this._bid = bidAmount;
            }
        }

        determineBid() {
            let currentBid = 0;
            if (this._spadesInHand.length === 0) {
                // Check if I have any aces or face cards. If not, I probably want to bid nil this hand
                if (containsQueenOrHigher(this._heartsInHand) || containsQueenOrHigher(this._clubsInHand) || containsQueenOrHigher(this._diamondsInHand)) {
                    // Look for aces

                }
                else {
                    // bid nil
                    return currentBid; 
                }
            }
            else {
                // If I have the ace of spades, that's a guaranteed trick.
                if (this.containsAnAce(this._spadesInHand)) {
                    currentBid++;
                }
                if (this.containsAKing(this._spadesInHand)) {
                    currentBid++;
                }
                
                if (this._spadesInHand.length > 2) {
                    // If there are low counts of cards in one of these suits, spades will probably be useful there
                    if (this._heartsInHand.length < 3) {
                        currentBid++;
                    }
                    if (this._clubsInHand.length < 3) {
                        currentBid++;
                    }
                    if (this._diamondsInHand.length < 3) {
                        currentBid++;
                    }
                }
                // If we have 5 spades, assume that we'll be able to get at least one more trick
                if (this._spadesInHand.length > 4) {
                    currentBid++;
                }
            }

            currentBid += this.getSuitBidCount(this._heartsInHand);
            currentBid += this.getSuitBidCount(this._clubsInHand);
            currentBid += this.getSuitBidCount(this._diamondsInHand);

            return currentBid;
        }

        getSuitBidCount(cardArray) {
            let currentBid = 0;
            if (cardArray.length < 5 && this.containsAnAce(cardArray)) {
                currentBid++;
            }
            if (cardArray.length < 3 && this.containsAKing(cardArray)) {
                currentBid++;
            }
            return currentBid;
        }

        containsAnAce(cardArray) {
            if (cardArray.find(card => card._rank === 14) != null) {
                return true;
            }
            else {
                return false;
            }
        }

        containsAKing(cardArray) {
            if (cardArray.find(card => card._rank === 13) != null) {
                return true;
            }
            else {
                return false;
            }
        }

        containsQueenOrHigher(cardArray) {
            let result = false;
            let i = 0;
            for (i = 0; i < cardArray.length; i++) {
                if (cardArray[i]._discarded) {
                    continue;
                }
                else {
                    if (cardArray[i]._rank > 11) {
                        result = true;
                        break;
                    }
                }
            }
        }
    }

    // Functions
    function startGame() {
        // The Deck constructor should shuffle the cards, so no need to do it again here.
        deck = new Deck();
        player1 = new Player("Player1");
        player2 = new Player("COM2");
        player3 = new Player("COM3");
        player4 = new Player("COM4");
        dealerIndex = getRandomIntInclusive(0, 3);

        // It's not important to deal each card to every player in sequence since we know the cards in the deck are already random.
        player1.drawFullHand();
        player2.drawFullHand();
        player3.drawFullHand();
        player4.drawFullHand();

        let player1HandArray = player1.getHandArray();

        let i = 0;
        for (i = 0; i < player1HandArray.length; i++) {
            let currentCard = player1HandArray[i];
            let htmlInput = new HtmlInput("playerCard" + i, rankStrings[currentCard._rank] + suitStrings[currentCard._suit]);
            if (currentCard._suit === Suit.Diamond || currentCard._suit === Suit.Heart) {
                htmlInput.setColorRed();
            }
            if (currentCard._suit === Suit.Club || currentCard._suit === Suit.Spade) {
                htmlInput.setColorBlack();
            }
            Player1CardInputs.push(htmlInput);
        }

        Player1CardDiv = new HtmlDiv("Player1Card", "");
        Player2CardDiv = new HtmlDiv("Player2Card", "");
        Player3CardDiv = new HtmlDiv("Player3Card", "");
        Player4CardDiv = new HtmlDiv("Player4Card", "");

        getNextPlayer(dealerIndex);
        player1.setBid(player1.determineBid());
        player2.setBid(player2.determineBid());
        player3.setBid(player3.determineBid());
        player4.setBid(player4.determineBid());
        console.log(player1);
        console.log(player2);
        console.log(player3);
        console.log(player4);
        
    }

    function getNextPlayer(playerIndex) {
        var newIndex = playerIndex++;
        if (newIndex > 3) {
            newIndex = 0;
        }
        return newIndex;
    }

    function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

    function dealNewHand() {
        deck = new Deck();
        player1.drawFullHand();
        player2.drawFullHand();
        player3.drawFullHand();
        player4.drawFullHand();
    }

    function playCard(cardId) {
        if (Player1CardInputs !== null && Player1CardInputs.length > cardId) {
            Player1CardInputs[cardId].hide();
        }
        Player1CardDiv.setInnerHtml(Player1CardInputs[cardId]._element.value);
        if(Player1CardInputs[cardId]._element.style.color === "red") {
            Player1CardDiv.setColorRed();
        }
        else {
            Player1CardDiv.setColorBlack();
        }
    }

    function resetGame() {

    }

    document.getElementById("playerCard0").addEventListener('click', function () {playCard(0)});
    document.getElementById("playerCard1").addEventListener('click', function () {playCard(1)});
    document.getElementById("playerCard2").addEventListener('click', function () {playCard(2)});
    document.getElementById("playerCard3").addEventListener('click', function () {playCard(3)});
    document.getElementById("playerCard4").addEventListener('click', function () {playCard(4)});
    document.getElementById("playerCard5").addEventListener('click', function () {playCard(5)});
    document.getElementById("playerCard6").addEventListener('click', function () {playCard(6)});
    document.getElementById("playerCard7").addEventListener('click', function () {playCard(7)});
    document.getElementById("playerCard8").addEventListener('click', function () {playCard(8)});
    document.getElementById("playerCard9").addEventListener('click', function () {playCard(9)});
    document.getElementById("playerCard10").addEventListener('click', function () {playCard(10)});
    document.getElementById("playerCard11").addEventListener('click', function () {playCard(11)});
    document.getElementById("playerCard12").addEventListener('click', function () {playCard(12)});

    // Main game:
    startGame();


</script>

</html>