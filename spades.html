<!DOCTYPE html>

<head>
    <link rel="stylesheet" type="text/css" href="shared.css" />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="stylesheet" type="text/css" href="spades.css" />
</head>

<body>
    <div id="ScoreboardModal">
        <div id="ScoreboardModalBox">
            <div id="ModalTitle">Score Summary:</div>
            <div id="ModalBoardsContainer">
                <div id="ModalTeam1Board">
                    <div id="ModalTeam1Title">Team 1:</div>
                    <div id="ModalPlayer1NilResultText">
                        <div class="modal-scoreboard-label">Player 1 Nil Result:</div>
                        <div id="ModalPlayer1NilResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalPlayer3NilResultText">
                        <div class="modal-scoreboard-label">Player 3 Nil Result:</div>
                        <div id="ModalPlayer3NilResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1BidLabel">
                        <div class="modal-scoreboard-label">Combined Team Bid:</div>
                        <div id="ModalTeam1BidValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1TricksLabel">
                        <div class="modal-scoreboard-label">Combined Team Tricks:</div>
                        <div id="ModalTeam1TricksValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1BidResultLabel">
                        <div class="modal-scoreboard-label">Bid Contract Result:</div>
                        <div id="ModalTeam1BidResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1SandbagsLabel">
                        <div class="modal-scoreboard-label">Sandbags Taken:</div>
                        <div id="ModalTeam1SandbagsValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1SandbagPenaltyLabel">
                        <div class="modal-scoreboard-label">Sandbag Penalty (10 bags = -100):</div>
                        <div id="ModalTeam1SandbagPenaltyValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1TotalScoreLabel">
                        <div class="modal-scoreboard-label">Total Score:</div>
                        <div id="ModalTeam1TotalScoreValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam1TotalSandbagsLabel">
                        <div class="modal-scoreboard-label">Total Sandbags:</div>
                        <div id="ModalTeam1TotalSandbagsValue" class="modal-scoreboard-label">0</div>
                    </div>
                </div>
    
                <div id="ModalTeam2Board">
                    <div id="ModalTeam2Title">Team 2:</div>
                    <div id="ModalPlayer2NilResultText">
                        <div class="modal-scoreboard-label">Player 2 Nil Result:</div>
                        <div id="ModalPlayer2NilResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalPlayer4NilResultText">
                        <div class="modal-scoreboard-label">Player 4 Nil Result:</div>
                        <div id="ModalPlayer4NilResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2BidLabel">
                        <div class="modal-scoreboard-label">Combined Team Bid:</div>
                        <div id="ModalTeam2BidValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2TricksLabel">
                        <div class="modal-scoreboard-label">Combined Team Tricks:</div>
                        <div id="ModalTeam2TricksValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2BidResultLabel">
                        <div class="modal-scoreboard-label">Bid Contract Result:</div>
                        <div id="ModalTeam2BidResultValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2SandbagsLabel">
                        <div class="modal-scoreboard-label">Sandbags Taken:</div>
                        <div id="ModalTeam2SandbagsValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2SandbagPenaltyLabel">
                        <div class="modal-scoreboard-label">Sandbag Penalty (10 bags = -100):</div>
                        <div id="ModalTeam2SandbagPenaltyValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2TotalScoreLabel">
                        <div class="modal-scoreboard-label">Total Score:</div>
                        <div id="ModalTeam2TotalScoreValue" class="modal-scoreboard-label">0</div>
                    </div>
                    <div id="ModalTeam2TotalSandbagsLabel">
                        <div class="modal-scoreboard-label">Total Sandbags:</div>
                        <div id="ModalTeam2TotalSandbagsValue" class="modal-scoreboard-label">0</div>
                    </div>
                </div>
            </div>
            

            <div id="ModalContinueContainer">
                <input id="ModalContinue" type="button" value="Continue" />
            </div>
            

        </div>
    </div>
    <div id="GameContainer">
        <div id="ScoreArea">
            <div id="Team1NameAndScore">
                <div id="Team1Name">Team 1 (Player1 and COM3)</div>
                <div>
                    <div class="score-area-text">Score:</div>
                    <div id="Team1Score" class="score-area-text">0</div>
                </div>

                <div>
                    <div class="score-area-text">Sandbags:</div>
                    <div id="Team1Sandbags" class="score-area-text">0</div>
                </div>
            </div>
            <div id="ScoreLimitText"
                title="The score limit determines when the game is over. If you have -150 points or fewer, you lose. If you have 250 points or more, you win.">
                Score limit: (Min -150 / Max 250)</div>
            <div id="Team2NameAndScore">
                <div id="Team2Name">Team 2 (COM2 and COM4)</div>
                <div>
                    <div class="score-area-text">Score:</div>
                    <div id="Team2Score" class="score-area-text">0</div>
                </div>
                <div>
                    <div class="score-area-text">Sandbags:</div>
                    <div id="Team2Sandbags" class="score-area-text">0</div>
                </div>
            </div>
        </div>
        <div id="PlayArea">
            <div id="Player3Data">
                <div id="Player3Card" class="play-area-card"></div>
                <div id="Player3Name" class="data-text">COM3</div>
                <div id="Player3TricksToBids"
                    title="The left number is the number of tricks won. The right number is the player's bid."
                    class="data-text">
                    <div id="Player3Tricks" class="data-text">-</div>/<div id="Player3Bid" class="data-text">-</div>
                </div>
            </div>
            <div id="WestAndEastCardContainer">
                <div id="Player2Data">
                    <div id="Player2Card" class="play-area-card"></div>
                    <div id="Player2Name" class="data-text">COM2</div>
                    <div id="Player2TricksToBids"
                        title="The left number is the number of tricks won. The right number is the player's bid."
                        class="data-text">
                        <div id="Player2Tricks" class="data-text">-</div>/<div id="Player2Bid" class="data-text">-</div>
                    </div>
                </div>
                <div id="Player4Data">
                    <div id="Player4Card" class="play-area-card"></div>
                    <div id="Player4Name" class="data-text">COM4</div>
                    <div id="Player4TricksToBids"
                        title="The left number is the number of tricks won. The right number is the player's bid."
                        class="data-text">
                        <div id="Player4Tricks" class="data-text">-</div>/<div id="Player4Bid" class="data-text">-</div>
                    </div>
                </div>
            </div>
            <div id="Player1Data">
                <div id="Player1Card" class="play-area-card"></div>
                <div id="Player1Name" class="data-text">Player1</div>
                <div id="Player1TricksToBids"
                    title="The left number is the number of tricks won. The right number is the player's bid."
                    class="data-text">
                    <div id="Player1Tricks" class="data-text">-</div>/<div id="Player1Bid" class="data-text">-</div>
                </div>
            </div>
        </div>
        <div id="PlayerCardsContainer">
            <input id="playerCard0" class="player-card" type="button" />
            <input id="playerCard1" class="player-card" type="button" />
            <input id="playerCard2" class="player-card" type="button" />
            <input id="playerCard3" class="player-card" type="button" />
            <input id="playerCard4" class="player-card" type="button" />
            <input id="playerCard5" class="player-card" type="button" />
            <input id="playerCard6" class="player-card" type="button" />
            <input id="playerCard7" class="player-card" type="button" />
            <input id="playerCard8" class="player-card" type="button" />
            <input id="playerCard9" class="player-card" type="button" />
            <input id="playerCard10" class="player-card" type="button" />
            <input id="playerCard11" class="player-card" type="button" />
            <input id="playerCard12" class="player-card" type="button" />
        </div>
        <div id="PlayerBidContainer">
            <div id="BidLabel">Enter Bid:</div>
            <input id="PlayerBidInput" placeholder="# of tricks" type="text" />
            <input id="PlayerBidSubmit" type="button" value="Submit" />
        </div>
    </div>

    <div id="SideInfo">
        <div>Sidebar stuff</div>
    </div>

</body>
<style>

</style>

<script>

    // Globals
    let deck = null;
    let player1 = null;
    let player2 = null;
    let player3 = null;
    let player4 = null;
    let Player1CardDiv = null;
    let Player2CardDiv = null;
    let Player3CardDiv = null;
    let Player4CardDiv = null;
    let PlayerBidInput = null;
    let PlayerBidContainerDiv = null;
    let Team1ScoreDiv = null;
    let Team2ScoreDiv = null;
    let Team1SandbagsDiv = null;
    let Team2SandbagsDiv = null;
    let dealerIndex = null;
    let players = [];
    let currentBidCount = 0; // Once this is higher than 3, bidding is no longer active
    let currentPlayerTurn = null;
    let currentPlayedCards = [null, null, null, null];
    let cardsPlayedThisRound = 0;
    let spadesBrokenThisGame = false;
    let currentRoundSuit = null;
    let highestCurrentRoundCard = null;
    let Player1CardsWithInputs = [];
    let totalHandsPlayed = 0;
    let Player1AndPlayer3Score = 0;
    let Player2AndPlayer4Score = 0;
    let Player1AndPlayer3Sandbags = 0;
    let Player2AndPlayer4Sandbags = 0;
    let maxScoreLimit = 250;
    let minScoreLimit = -150;
    let scoreboardModal = null;
    let endGame = false;
    let handlingPlayerClick = false;

    // There should not be a reason to access index 0 or 1, but other indices correspond to card ranks in order of strength.
    const rankStrings = ["", "", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];

    const suitStrings = ["♠", "♥", "♣", "♦"];

    // Enums
    const Suit = {
        Spade: 0,
        Heart: 1,
        Club: 2,
        Diamond: 3
    }

    // Classes
    class HtmlDiv {
        constructor(divId, defaultInnerHtml) {
            this._divId = divId;
            this._element = document.getElementById(divId);
            // Make defaultInnerHtml optional param
            if (defaultInnerHtml !== undefined) {
                this._element.innerHTML = defaultInnerHtml;
            }
        }

        hide() {
            this._element.style.display = "none";
        }

        showBlock() {
            this._element.style.display = "block";
        }

        showInlineBlock() {
            this._element.style.display = "inline-block";
        }

        setInnerHtml(input) {
            this._element.innerHTML = input;
        }

        setColorRed() {
            this._element.style.color = "red";
        }

        setColorBlack() {
            this._element.style.color = "black";
        }

        setColorGreen() {
            this._element.style.color = "#03DAC6";
        }

        setColorWhite() {
            this._element.style.color = "#FFFFFF";
        }

        setBackgroundGray() {
            this._element.style.backgroundColor = "#424242";
        }

        setBackgroundWhite() {
            this._element.style.backgroundColor = "#FFFFFF";
        }

        setClassName(inputClassName) {
            this._element.className = inputClassName;
        }
    }

    class HtmlInput {
        constructor(inputId, val) {
            this._inputId = inputId;
            this._element = document.getElementById(inputId);
            // Make val optional param
            if (val !== undefined) {
                this._element.value = val;
            }
            this._element.addEventListener('mouseover', function (e) {
                e.preventDefault();
                let tempDiv = new HtmlDiv("SideInfo");
                tempDiv.setInnerHtml(this._element.value);
                tempDiv.showBlock();
            }.bind(this));

            this._element.addEventListener('mouseout', function (e) {
                e.preventDefault();
                let tempDiv = new HtmlDiv("SideInfo");
                tempDiv.setInnerHtml("");
                tempDiv.hide();
            }.bind(this));
        }

        hide() {
            this._element.style.display = "none";
        }

        showBlock() {
            this._element.style.display = "block";
        }

        showInlineBlock() {
            this._element.style.display = "inline-block";
        }

        getValue() {
            return this._element.value;
        }

        setValue(val) {
            this._element.value = val;
        }

        setColorRed() {
            this._element.style.color = "red";
        }

        setColorBlack() {
            this._element.style.color = "black";
        }
    }

    class CardWithHtmlInput {
        constructor(card, htmlInput) {
            this._card = card;
            this._htmlInput = htmlInput;
            this._htmlInput.showInlineBlock();
            this._handlingClick = false;
        }

        setHandlingClick(input) {
            this._handlingClick = input;
        }
    }

    class Card {
        constructor(rank, suit) {
            this._rank = rank;
            this._suit = suit;
        }

        getString() {
            return rankStrings[this._rank] + suitStrings[this._suit];
        }

        isRed() {
            return (this._suit === Suit.Heart || this._suit === Suit.Diamond);
        }

        isBlack() {
            return (this._suit === Suit.Spade || this._suit === Suit.Club);
        }
    }

    class Deck {
        constructor() {
            this._cards = [];
            this.addAllRanksForSuit(Suit.Spade);
            this.addAllRanksForSuit(Suit.Heart);
            this.addAllRanksForSuit(Suit.Diamond);
            this.addAllRanksForSuit(Suit.Club);
            this.shuffle();
        }

        addAllRanksForSuit(suit) {
            let i = 0;
            for (i = 0; i < 13; i++) {
                let newCard = new Card(i + 2, suit);
                this._cards.push(newCard);
            }
        }

        shuffle() {
            for (let i = this._cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [this._cards[i], this._cards[j]] = [this._cards[j], this._cards[i]];
            }
        }

        draw() {
            if (this._cards.length > 0) {
                return this._cards.shift();
            }
            else {
                console.log("Deck was empty when trying to draw.");
                return null;
            }
        }
    }

    class Player {
        constructor(name, isHuman, playerPrefix) {
            this._name = name;
            this._isHuman = isHuman;
            this._cards = [[], [], [], []]; // One empty array per suit
            this._bid = null;
            this._tricksTaken = 0;
            this._playAreaDiv = new HtmlDiv(playerPrefix + "Card");
            this._dataDiv = new HtmlDiv(playerPrefix + "Data");
            this._nameDiv = new HtmlDiv(playerPrefix + "Name");
            this._tricksToBidsDiv = new HtmlDiv(playerPrefix + "TricksToBids");
            this._tricksDiv = new HtmlDiv(playerPrefix + "Tricks");
            this._bidDiv = new HtmlDiv(playerPrefix + "Bid");
        }

        addToHand(card) {
            this._cards[card._suit].push(card);
        }

        drawFullHand() {
            if (deck !== null && deck._cards.length >= 13) {
                let i = 0;
                for (i = 0; i < 13; i++) {
                    this.addToHand(deck.draw());
                }
                this.sortByRank(this._cards[Suit.Spade]);
                this.sortByRank(this._cards[Suit.Heart]);
                this.sortByRank(this._cards[Suit.Club]);
                this.sortByRank(this._cards[Suit.Diamond]);
            }
            else {
                console.log("The deck contained less than 13 cards when trying to deal a full hand.");
            }
        }

        updatePlayArea(card) {
            this._playAreaDiv.setBackgroundWhite();
            this._playAreaDiv.setInnerHtml(card.getString());
            if (card.isRed()) {
                this._playAreaDiv.setColorRed();
            }
            else if (card.isBlack()) {
                this._playAreaDiv.setColorBlack();
            }
        }

        incrementTricks() {
            this._tricksTaken++;
            this._tricksDiv.setInnerHtml(this._tricksTaken);
        }

        resetBidAndTricks() {
            this._cards = [[], [], [], []]; // One empty array per suit
            this._tricksTaken = 0;
            this._bid = null;
            this._tricksDiv.setInnerHtml("-");
            this._bidDiv.setInnerHtml("-");
        }

        removeCardFromHandIfExists(card) {
            if (this._cards[card._suit].length > 0) {
                let cardIndex = this._cards[card._suit].findIndex(findCard => findCard._rank === card._rank && findCard._suit === card._suit);
                if (cardIndex > -1) {
                    this._cards[card._suit].splice(cardIndex, 1);
                }
            }
        }

        getHandArray() {
            this._handArray = this._cards[Suit.Heart].concat(this._cards[Suit.Club].concat(this._cards[Suit.Diamond].concat(this._cards[Suit.Spade])));
            return this._handArray;
        }

        async playCard(card) {
            this.removeCardFromHandIfExists(card);
            cardsPlayedThisRound++;
            if (spadesBrokenThisGame === false && card._suit === Suit.Spade) {
                spadesBrokenThisGame = true;
            }
            currentPlayedCards[currentPlayerTurn] = card;

            console.log("Player " + this._name + " played: " + card.getString());
            this.updatePlayArea(card);

            if (highestCurrentRoundCard !== null) {
                if (card._suit === Suit.Spade) {
                    if (highestCurrentRoundCard._suit !== Suit.Spade) {
                        highestCurrentRoundCard = card;
                    }
                    else {
                        if (card._rank > highestCurrentRoundCard._rank) {
                            highestCurrentRoundCard = card;
                        }
                    }
                }
                else {
                    if (card._suit === currentRoundSuit) {
                        if (card._rank > highestCurrentRoundCard._rank && highestCurrentRoundCard._suit !== Suit.Spade) {
                            highestCurrentRoundCard = card;
                        }
                    }
                }
            }
            else {
                highestCurrentRoundCard = card;
                currentRoundSuit = card._suit;
            }

            if (cardsPlayedThisRound === 4) {
                // Set score and reset round state
                cardsPlayedThisRound = 0;
                let winnerIndex = null;
                let i = 0;
                for (i = 0; i < currentPlayedCards.length; i++) {
                    if (highestCurrentRoundCard._suit === currentPlayedCards[i]._suit && highestCurrentRoundCard._rank === currentPlayedCards[i]._rank) {
                        winnerIndex = i;
                    }
                    // if (winnerIndex === null) {
                    //     winnerIndex = i;
                    // }
                    // else {
                    //     let currentCard = currentPlayedCards[i];
                    //     let winnerCard = currentPlayedCards[winnerIndex];
                    //     // If suits are the same, take the higher rank.
                    //     if (currentCard._suit === winnerCard._suit) {
                    //         if (currentCard._rank > winnerCard._rank) {
                    //             winnerIndex = i;
                    //         }
                    //     }
                    //     else if (currentCard._suit === Suit.Spade) {
                    //         // If suit is spade, this wins because the current winner is not a spade.
                    //         winnerIndex = i;
                    //     }
                    //     else if (currentCard._suit === currentRoundSuit) {
                    //         // If the suit is the current round's suit to follow, this wins because the current winner is neither a spade nor the suit to follow.
                    //         winnerIndex = i;
                    //     }
                    //     else {
                    //         // This case means neither this card nor the current winner are the current suit to follow or spades, so it doesn't matter if I set winnerIndex to i here.
                    //         winnerIndex = i;
                    //     }
                    // }
                }

                players[winnerIndex].incrementTricks();

                currentPlayedCards = [null, null, null, null];
                highestCurrentRoundCard = null;
                currentRoundSuit = null;
                await sleep(1000);
                movePlayAreaCardsToWinner(winnerIndex);
                await sleep(500);
                clearPlayAreaCards();
                hideAllPlayAreaCards();

                totalHandsPlayed++;
                if (totalHandsPlayed === 13) {
                    endGame = tallyCurrentRoundScore();
                    scoreboardModal.showScoreboard();
                    return;
                }

                setCurrentPlayerTurn(winnerIndex);
                handlingPlayerClick = false;
                let newRoundPlayer = players[currentPlayerTurn];

                if (!newRoundPlayer._isHuman) {
                    await sleep(500);
                    await newRoundPlayer.playCard(newRoundPlayer.findCardToPlay());
                    return;
                }
                else {
                    return;
                }
            }

            nextTurn();
            let nextPlayer = players[currentPlayerTurn];
            if (nextPlayer._isHuman === false) {
                await sleep(500);
                await nextPlayer.playCard(nextPlayer.findCardToPlay());
            }
            return;
        }

        findCardToPlay() {
            if (this._bid === 0) {
                if (cardsPlayedThisRound === 0) {
                    if (spadesBrokenThisGame === true) {
                        let lowestSpade = this.getLowestOfSuit(Suit.Spade);
                        if (lowestSpade !== null) {
                            return lowestSpade;
                        }
                    }
                    let lowestCardAvailable = this.getLowestAvailableCard();
                    if (lowestCardAvailable !== null) {
                        return lowestCardAvailable;
                    }
                    else {
                        console.log("Error: Lowest card available was null.");
                    }
                }
                else {
                    // Follow suit if possible and play a card that will either win or minimize loss in value
                    if (this._cards[currentRoundSuit].length > 0) {
                        let followSuitCard = this.getLowestOfSuit(currentRoundSuit);
                        if (followSuitCard !== null) {
                            return followSuitCard;
                        }
                        let lowestCard = this.getLowestAvailableCard();
                        if (lowestCard !== null) {
                            return lowestCard;
                        }
                        else {
                            console.log("Error: The lowest available card was null.");
                        }
                    }
                    else {
                        // You can either play a spade or throw off a bad card from another suit
                        if (this._tricksTaken < this._bid) {
                            let lowestSpade = this.getLowestOfSuit(Suit.Spade);
                            if (lowestSpade !== null) {
                                return lowestSpade;
                            }
                            let lowestAvailableCard = this.getLowestAvailableCard();
                            if (lowestAvailableCard !== null) {
                                return lowestAvailableCard;
                            }
                            else {
                                console.log("Error: That lowest available card was null.");
                            }
                        }
                        let lowestAvailCard = this.getLowestAvailableCard();
                        if (lowestAvailCard !== null) {
                            return lowestAvailCard;
                        }
                        else {
                            console.log("Error: The lowest avail card was null.");
                        }
                    }
                }
            }
            else {
                if (cardsPlayedThisRound === 0) {
                    // Just pick a valid card
                    if (spadesBrokenThisGame) {
                        // Consider spades as a lead suit
                        let nonSpadeAce = this.getNonSpadeAce();
                        if (nonSpadeAce !== null) {
                            return nonSpadeAce;
                        }
                        let highestSpade = this.getHighSpadeIfAvailable();
                        if (highestSpade !== null) {
                            return highestSpade;
                        }
                        let lowestSpade = this.getLowestOfSuit(Suit.Spade);
                        if (lowestSpade !== null) {
                            return lowestSpade;
                        }
                        let lowestCardAvailable = this.getLowestAvailableCard();
                        if (lowestCardAvailable !== null) {
                            return lowestCardAvailable;
                        }
                        else {
                            console.log("Error: Lowest card available was null.");
                        }
                    }
                    else {
                        // Only consider hearts, clubs, and diamonds as lead suits
                        let highestNonSpade = this.getHighestAvailableCardNoSpades();
                        if (highestNonSpade !== null) {
                            return highestNonSpade;
                        }
                        let lowest = this.getLowestAvailableCardNotASpade();
                        if (lowest !== null) {
                            return lowest;
                        }
                        let lowestSpade = this.getLowestOfSuit(Suit.Spade);
                        if (lowestSpade !== null) {
                            return lowestSpade;
                        }
                        else {
                            console.log("Error: Lowest spade was null.");
                        }
                    }
                }
                else {
                    // Follow suit if possible and play a card that will either win or minimize loss in value
                    if (this._cards[currentRoundSuit].length > 0) {
                        let followSuitCard = this.getCardThatBeatsOrGoesLow();
                        if (followSuitCard !== null) {
                            return followSuitCard;
                        }
                        if (this._tricksTaken < this._bid) {
                            let lowestSpade = this.getLowestOfSuit(Suit.Spade);
                            if (lowestSpade !== null) {
                                return lowestSpade;
                            }
                            let lowestAvailable = this.getLowestAvailableCard();
                            if (lowestAvailable !== null) {
                                return lowestAvailable;
                            }
                            else {
                                console.log("Error: This lowest available was null.");
                            }
                        }
                        let lowestCard = this.getLowestAvailableCard();
                        if (lowestCard !== null) {
                            return lowestCard;
                        }
                        else {
                            console.log("Error: The lowest available card was null.");
                        }
                    }
                    else {
                        let lowestSpadeThatCouldWin = this.getLowestSpadeThatCouldWin();
                        if (lowestSpadeThatCouldWin !== null) {
                            return lowestSpadeThatCouldWin;
                        }
                        let lowestNonSpade = this.getLowestAvailableCard();
                        if (lowestNonSpade !== null) {
                            return lowestNonSpade;
                        }
                        else {
                            console.log("Error, couldn't find a card to play");
                        }
                    }
                }
            }
        }

        getNonSpadeAce() {
            let i = 1;
            for (i = 1; i < this._cards.length; i++) {
                if (this.containsAnAce(this._cards[i]) === true) {
                    return this._cards[i].pop();
                }
            }
            return null;
        }

        getHighestAvailableCardNoSpades() {
            let i = 1;
            for (i = 1; i < this._cards.length; i++) {
                if (this.containsAnAce(this._cards[i]) === true) {
                    return this._cards[i].pop();
                }
            }
            for (i = 1; i < this._cards.length; i++) {
                if (this.containsAKing(this._cards[i]) === true) {
                    return this._cards[i].pop();
                }
            }
            for (i = 1; i < this._cards.length; i++) {
                if (this.containsAQueen(this._cards[i]) === true) {
                    return this._cards[i].pop();
                }
            }
            for (i = 1; i < this._cards.length; i++) {
                if (this.containsAJack(this._cards[i]) === true) {
                    return this._cards[i].pop();
                }
            }
            return null;
        }

        getHighSpadeIfAvailable() {
            if (this.containsAnAce(this._cards[Suit.Spade]) === true) {
                return this._cards[Suit.Spade].pop();
            }
            if (this.containsAKing(this._cards[Suit.Spade]) === true) {
                return this._cards[Suit.Spade].pop();
            }
            if (this.containsAQueen(this._cards[Suit.Spade]) === true) {
                return this._cards[Suit.Spade].pop();
            }
            return null;
        }

        getLowestAvailableCard() {
            let lowest = this.getLowestAvailableCardNotASpade();
            if (lowest !== null) {
                return lowest;
            }
            if (this._cards[Suit.Spade].length > 0) {
                return this._cards[Suit.Spade].shift();
            }
            return null;
        }

        getLowestAvailableCardNotASpade() {
            if (this._cards[Suit.Heart].length > 0) {
                return this._cards[Suit.Heart].shift();
            }
            if (this._cards[Suit.Club].length > 0) {
                return this._cards[Suit.Club].shift();
            }
            if (this._cards[Suit.Diamond].length > 0) {
                return this._cards[Suit.Diamond].shift();
            }
            return null;
        }

        getLowestSpadeThatCouldWin() {
            if (highestCurrentRoundCard._suit !== Suit.Spade) {
                return this.getLowestOfSuit(Suit.Spade); // Return lowest Spade
            }
            else {
                // TODO: Fix this path. Need to look through cards and return a good one other than the highest
                if (this._cards[Suit.Spade].length > 0) {
                    return this._cards[Suit.Spade].pop();
                }
                else {
                    return null;
                }
            }
        }

        getLowestOfSuit(suit) {
            if (this._cards[suit].length > 0) {
                return this._cards[suit].shift();
            }
            else {
                return null;
            }
        }

        getCardThatBeatsOrGoesLow() {
            let suitCards = this._cards[currentRoundSuit];
            if (suitCards.length === 0) {
                return null;
            }
            if (highestCurrentRoundCard._suit === Suit.Spade) {
                if (currentRoundSuit === Suit.Spade) {
                    // The current round's suit is Spades, so try to win with a good spade
                    if (highestCurrentRoundCard._rank > 9) {
                        let goodSpade = this.getHighSpadeIfAvailable(); // TODO: Remember this only gets Q, K, or A right now, so it's not guaranteed to return a valid card. Need to update it eventually
                        if (goodSpade !== null) {
                            return goodSpade;
                        }
                    }
                    let lowestSpadeThatCouldWin = this.getLowestSpadeThatCouldWin();
                    if (lowestSpadeThatCouldWin !== null) {
                        return lowestSpadeThatCouldWin;
                    }
                }
                return suitCards.shift(); // Return lowest card
            }
            // If highestCurrentRoundCard rank is higher than my highest card in the suit
            if (highestCurrentRoundCard._rank > suitCards[suitCards.length - 1]._rank) {
                return suitCards.shift(); // Return lowest card
            }
            else {
                return suitCards.pop(); // Return highest card
            }
        }

        sortByRank(suitList) {
            suitList.sort((a, b) => (a._rank > b._rank) ? 1 : -1);
        }

        getListString(suitList) {
            let result = "";
            let i = 0;
            for (i = 0; i < suitList.length; i++) {
                result += suitList[i].getString();
                if (i != suitList.length - 1) {
                    result += " ";
                }

            }
            return result;
        }

        clearBid() {
            this._bid = null;
        }

        setBid(bidAmount) {
            if (bidAmount < 0 || bidAmount > 13) {
                console.log("Bid amount was out of bounds: " + bidAmount);
            }
            else {
                this._bid = bidAmount;
                this._bidDiv.setInnerHtml(this._bid);
                this._tricksToBidsDiv.showBlock();
            }
        }

        determineBid() {
            let currentBid = 0;
            if (this._cards[Suit.Spade].length === 0) {
                // Check if I have any aces or face cards. If not, I probably want to bid nil this hand
                if (this.containsQueenOrHigher(this._cards[Suit.Heart]) === false && this.containsQueenOrHigher(this._cards[Suit.Diamond]) === false && this.containsQueenOrHigher(this._cards[Suit.Club]) === false) {
                    // bid nil
                    return currentBid;
                }
            }
            else {
                // If I have the ace of spades, that's a guaranteed trick.
                if (this.containsAnAce(this._cards[Suit.Spade]) === true) {
                    currentBid++;
                }
                if (this.containsAKing(this._cards[Suit.Spade]) === true) {
                    currentBid++;
                }
                if (this.containsAQueen(this._cards[Suit.Spade]) === true) {
                    currentBid++;
                }

                if (this._cards[Suit.Spade].length > 2) {
                    // If there are low counts of cards in one of these suits, spades will probably be useful there
                    if (this._cards[Suit.Heart].length < 3) {
                        currentBid++;
                    }
                    if (this._cards[Suit.Diamond].length < 3) {
                        currentBid++;
                    }
                    if (this._cards[Suit.Club].length < 3) {
                        currentBid++;
                    }
                }
                // If we have 5 spades, assume that we'll be able to get at least one more trick
                if (this._cards[Suit.Spade].length > 4) {
                    let spadesOver4 = this._cards[Suit.Spade].length - 4;
                    currentBid += spadesOver4;
                }
            }

            currentBid += this.getSuitBidCount(this._cards[Suit.Heart]);
            currentBid += this.getSuitBidCount(this._cards[Suit.Diamond]);
            currentBid += this.getSuitBidCount(this._cards[Suit.Club]);

            return currentBid;
        }

        getSuitBidCount(cardArray) {
            let currentBid = 0;
            if (cardArray.length < 6 && this.containsAnAce(cardArray) === true) {
                if (cardArray.length < 4 && this.containsAKing(cardArray) === true) {
                    currentBid++;
                }
                if (cardArray.length < 3 && this.containsAQueen(cardArray) === true) {
                    currentBid++;
                }
                currentBid++;
            }
            return currentBid;
        }

        containsAnAce(cardArray) {
            if (cardArray.find(card => card._rank === 14) !== undefined) {
                return true;
            }
            else {
                return false;
            }
        }

        containsAKing(cardArray) {
            if (cardArray.find(card => card._rank === 13) !== undefined) {
                return true;
            }
            else {
                return false;
            }
        }

        containsAQueen(cardArray) {
            if (cardArray.find(card => card._rank === 12) !== undefined) {
                return true;
            }
            else {
                return false;
            }
        }

        containsAJack(cardArray) {
            if (cardArray.find(card => card._rank === 11) !== undefined) {
                return true;
            }
            else {
                return false;
            }
        }

        containsQueenOrKing(cardArray) {
            if (cardArray.find(card => card._rank === 12) !== undefined || cardArray.find(card => card._rank === 13) !== undefined) {
                return true;
            }
            else {
                return false;
            }
        }

        containsQueenOrHigher(cardArray) {
            let i = 0;
            for (i = 0; i < cardArray.length; i++) {
                if (cardArray[i]._rank > 11) {
                    return true;
                }
            }
            return false;
        }
    }

    class Scoreboard {
        constructor() {
            this._scoreboardModal = new HtmlDiv("ScoreboardModal");
            this._scoreboardTitle = new HtmlDiv("ModalTitle");

            this._player1NilResultText = new HtmlDiv("ModalPlayer1NilResultText");
            this._player1NilResultValue = new HtmlDiv("ModalPlayer1NilResultValue");
            this._player3NilResultText = new HtmlDiv("ModalPlayer3NilResultText");
            this._player3NilResultValue = new HtmlDiv("ModalPlayer3NilResultValue");
            this._modalTeam1BidLabel = new HtmlDiv("ModalTeam1BidLabel");
            this._modalTeam1BidValue = new HtmlDiv("ModalTeam1BidValue");
            this._modalTeam1TricksLabel = new HtmlDiv("ModalTeam1TricksLabel");
            this._modalTeam1TricksValue = new HtmlDiv("ModalTeam1TricksValue");
            this._modalTeam1BidResultLabel = new HtmlDiv("ModalTeam1BidResultLabel");
            this._modalTeam1BidResultValue = new HtmlDiv("ModalTeam1BidResultValue");
            this._modalTeam1SandbagsLabel = new HtmlDiv("ModalTeam1SandbagsLabel");
            this._modalTeam1SandbagsValue = new HtmlDiv("ModalTeam1SandbagsValue");
            this._modalTeam1SandbagPenaltyLabel = new HtmlDiv("ModalTeam1SandbagPenaltyLabel");
            this._modalTeam1SandbagPenaltyValue = new HtmlDiv("ModalTeam1SandbagPenaltyValue");
            this._modalTeam1TotalScoreLabel = new HtmlDiv("ModalTeam1TotalScoreLabel");
            this._modalTeam1TotalScoreValue = new HtmlDiv("ModalTeam1TotalScoreValue");
            this._modalTeam1TotalSandbagsLabel = new HtmlDiv("ModalTeam1TotalSandbagsLabel");
            this._modalTeam1TotalSandbagsValue = new HtmlDiv("ModalTeam1TotalSandbagsValue");

            this._player2NilResultText = new HtmlDiv("ModalPlayer2NilResultText");
            this._player2NilResultValue = new HtmlDiv("ModalPlayer2NilResultValue");
            this._player4NilResultText = new HtmlDiv("ModalPlayer4NilResultText");
            this._player4NilResultValue = new HtmlDiv("ModalPlayer4NilResultValue");
            this._modalTeam2BidLabel = new HtmlDiv("ModalTeam2BidLabel");
            this._modalTeam2BidValue = new HtmlDiv("ModalTeam2BidValue");
            this._modalTeam2TricksLabel = new HtmlDiv("ModalTeam2TricksLabel");
            this._modalTeam2TricksValue = new HtmlDiv("ModalTeam2TricksValue");
            this._modalTeam2BidResultLabel = new HtmlDiv("ModalTeam2BidResultLabel");
            this._modalTeam2BidResultValue = new HtmlDiv("ModalTeam2BidResultValue");
            this._modalTeam2SandbagsLabel = new HtmlDiv("ModalTeam2SandbagsLabel");
            this._modalTeam2SandbagsValue = new HtmlDiv("ModalTeam2SandbagsValue");
            this._modalTeam2SandbagPenaltyLabel = new HtmlDiv("ModalTeam2SandbagPenaltyLabel");
            this._modalTeam2SandbagPenaltyValue = new HtmlDiv("ModalTeam2SandbagPenaltyValue");
            this._modalTeam2TotalScoreLabel = new HtmlDiv("ModalTeam2TotalScoreLabel");
            this._modalTeam2TotalScoreValue = new HtmlDiv("ModalTeam2TotalScoreValue");
            this._modalTeam2TotalSandbagsLabel = new HtmlDiv("ModalTeam2TotalSandbagsLabel");
            this._modalTeam2TotalSandbagsValue = new HtmlDiv("ModalTeam2TotalSandbagsValue");

            this._modalContinue = new HtmlInput("ModalContinue");
        }

        updateScoreboardTitle(title) {
            this._scoreboardTitle.setInnerHtml(title);
            this._scoreboardTitle.setColorGreen();
        }

        resetScoreboardTitle() {
            this._scoreboardTitle.setInnerHtml("Score Summary:");
            this._scoreboardTitle.setColorWhite();
        }

        updateModalButtonText(text) {
            this._modalContinue.setValue(text);
        }

        showScoreboard() {
            this._scoreboardModal.showBlock();
        }

        hideScoreboard() {
            this._scoreboardModal.hide();
        }

        hideAllConditionalDetails() {
            this._player1NilResultText.hide();
            this._player3NilResultText.hide();
            this._modalTeam1SandbagPenaltyLabel.hide();

            this._player2NilResultText.hide();
            this._player4NilResultText.hide();
            this._modalTeam2SandbagPenaltyLabel.hide();
        }

        setPlayer1NilResult(result) {
            this._player1NilResultValue.setInnerHtml(result);
            this._player1NilResultText.showInlineBlock();
        }

        setPlayer3NilResult(result) {
            this._player3NilResultValue.setInnerHtml(result);
            this._player3NilResultText.showInlineBlock();
        }

        setTeam1BidValue(bid) {
            this._modalTeam1BidValue.setInnerHtml(bid);
        }

        setTeam1TricksValue(tricks) {
            this._modalTeam1TricksValue.setInnerHtml(tricks);
        }

        setTeam1BidResultValue(bidResult) {
            this._modalTeam1BidResultValue.setInnerHtml(bidResult);
        }

        setTeam1SandbagsTakenValue(sandbags) {
            this._modalTeam1SandbagsValue.setInnerHtml(sandbags);
        }

        setTeam1SandbagPenaltyValue(sandbagPenalty) {
            this._modalTeam1SandbagPenaltyValue.setInnerHtml(sandbagPenalty);
            this._modalTeam1SandbagPenaltyLabel.showInlineBlock();
        }

        setTeam1TotalScore(total) {
            this._modalTeam1TotalScoreValue.setInnerHtml(total);
        }

        setTeam1TotalSandbags(total) {
            this._modalTeam1TotalSandbagsValue.setInnerHtml(total);
        }

        setPlayer2NilResult(result) {
            this._player2NilResultValue.setInnerHtml(result);
            this._player2NilResultText.showInlineBlock();
        }

        setPlayer4NilResult(result) {
            this._player4NilResultValue.setInnerHtml(result);
            this._player4NilResultText.showInlineBlock();
        }

        setTeam2BidValue(bid) {
            this._modalTeam2BidValue.setInnerHtml(bid);
        }

        setTeam2TricksValue(tricks) {
            this._modalTeam2TricksValue.setInnerHtml(tricks);
        }

        setTeam2BidResultValue(bidResult) {
            this._modalTeam2BidResultValue.setInnerHtml(bidResult);
        }

        setTeam2SandbagsTakenValue(sandbags) {
            this._modalTeam2SandbagsValue.setInnerHtml(sandbags);
        }

        setTeam2SandbagPenaltyValue(sandbagPenalty) {
            this._modalTeam2SandbagPenaltyValue.setInnerHtml(sandbagPenalty);
            this._modalTeam2SandbagPenaltyLabel.showInlineBlock();
        }

        setTeam2TotalScore(total) {
            this._modalTeam2TotalScoreValue.setInnerHtml(total);
        }

        setTeam2TotalSandbags(total) {
            this._modalTeam2TotalSandbagsValue.setInnerHtml(total);
        }
    }

    // Functions
    function startGame() {
        // The Deck constructor should shuffle the cards, so no need to do it again here.
        deck = new Deck();
        player1 = new Player("Player1", true, "Player1");
        player2 = new Player("COM2", false, "Player2");
        player3 = new Player("COM3", false, "Player3");
        player4 = new Player("COM4", false, "Player4");
        players.push(player1);
        players.push(player2);
        players.push(player3);
        players.push(player4);
        dealerIndex = getRandomIntInclusive(0, 3);

        dealNewHand();

        Player1CardDiv = new HtmlDiv("Player1Card", "");
        Player2CardDiv = new HtmlDiv("Player2Card", "");
        Player3CardDiv = new HtmlDiv("Player3Card", "");
        Player4CardDiv = new HtmlDiv("Player4Card", "");
        PlayerBidInput = new HtmlInput("PlayerBidInput");
        PlayerBidContainerDiv = new HtmlDiv("PlayerBidContainer");
        Team1ScoreDiv = new HtmlDiv("Team1Score");
        Team2ScoreDiv = new HtmlDiv("Team2Score");
        Team1SandbagsDiv = new HtmlDiv("Team1Sandbags");
        Team2SandbagsDiv = new HtmlDiv("Team2Sandbags");
        scoreboardModal = new Scoreboard();
        scoreboardModal.hideAllConditionalDetails();
        handlingPlayerClick = false;

        setCurrentPlayerTurn(getNextPlayer(dealerIndex));
        initiateBidding();
    }

    function nextTurn() {
        setCurrentPlayerTurn(getNextPlayer(currentPlayerTurn));
    }

    function getNextPlayer(playerIndex) {
        var newIndex = playerIndex + 1;
        if (newIndex > 3) {
            newIndex = 0;
        }
        return newIndex;
    }

    function getRandomIntInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function hideAllPlayAreaCards() {
        players[0]._playAreaDiv.setClassName("play-area-card");
        players[1]._playAreaDiv.setClassName("play-area-card");
        players[2]._playAreaDiv.setClassName("play-area-card");
        players[3]._playAreaDiv.setClassName("play-area-card");
        let i = 0;
        for (i = 0; i < players.length; i++) {
            players[i]._playAreaDiv.setBackgroundGray();
        }
    }

    function dealNewHand() {
        // It's not important to deal each card to every player in sequence since we know the cards in the deck are already random.
        deck = new Deck();
        player1.drawFullHand();
        player2.drawFullHand();
        player3.drawFullHand();
        player4.drawFullHand();

        // TODO: Maybe put this array initialization somewhere else to group it with other "reset" logic
        Player1CardsWithInputs = [];

        let player1HandArray = player1.getHandArray();

        let i = 0;
        for (i = 0; i < player1HandArray.length; i++) {
            let currentCard = player1HandArray[i];
            let htmlInput = new HtmlInput("playerCard" + i, currentCard.getString());
            if (currentCard._suit === Suit.Diamond || currentCard._suit === Suit.Heart) {
                htmlInput.setColorRed();
            }
            if (currentCard._suit === Suit.Club || currentCard._suit === Suit.Spade) {
                htmlInput.setColorBlack();
            }
            Player1CardsWithInputs.push(new CardWithHtmlInput(currentCard, htmlInput));
        }
    }

    function initiateBidding() {
        for (i = 0; i < 4; i++) {
            if (players[currentPlayerTurn]._isHuman) {
                break;
            }
            else {
                players[currentPlayerTurn].setBid(players[currentPlayerTurn].determineBid());
            }
            currentBidCount++;
            nextTurn();
        }
    }

    async function submitBid() {
        let playerBidValue = parseInt(PlayerBidInput.getValue(), 10);
        if (playerBidValue > -1 && playerBidValue < 14) {
            player1.setBid(playerBidValue);
            PlayerBidContainerDiv.hide();
            currentBidCount++;
            nextTurn();
            // Continue computer bidding if there is any more to do
            if (currentBidCount < 4) {
                while (currentBidCount < 4) {
                    players[currentPlayerTurn].setBid(players[currentPlayerTurn].determineBid());
                    currentBidCount++;
                    nextTurn();
                }
            }
            // Start gameplay
            console.log(player1);
            console.log(player2);
            console.log(player3);
            console.log(player4);

            let currentPlayer = players[currentPlayerTurn];
            if (currentPlayer._isHuman === false) {
                await currentPlayer.playCard(currentPlayer.findCardToPlay());
            }
        }
        else {
            console.log("Bad bid amount");
        }
    }

    async function selectCard(cardId) {
        if (handlingPlayerClick === true) {
            return;
        }
        handlingPlayerClick = true;
        // If bidding is still active, don't allow cards to be played
        if (currentBidCount < 4) {
            alert("You must bid before playing a card!");
            handlingPlayerClick = false;
            return;
        }
        if (currentPlayerTurn !== 0) {
            alert("You must wait for your turn!");
            handlingPlayerClick = false;
            return;
        }
        let selectedCard = Player1CardsWithInputs[cardId]._card;
        if (currentRoundSuit === null && selectedCard._suit === Suit.Spade && spadesBrokenThisGame === false) {
            alert("Spades have not been broken this game!");
            handlingPlayerClick = false;
            return;
        }
        if (currentRoundSuit !== null && selectedCard._suit !== currentRoundSuit) {
            if (player1._cards[currentRoundSuit].length > 0) {
                alert("You must follow suit!");
                handlingPlayerClick = false;
                return;
            }
        }
        if (Player1CardsWithInputs !== null && Player1CardsWithInputs.length > cardId) {
            Player1CardsWithInputs[cardId]._htmlInput.hide();
            await player1.playCard(Player1CardsWithInputs[cardId]._card);
        }
        else {
            console.log("Player1CardsWithInputs was null in selectCard function");
        }
    }

    function tallyCurrentRoundScore() {
        let player1and3Bid = player1._bid + player3._bid;
        scoreboardModal.setTeam1BidValue(player1and3Bid);
        let player2and4Bid = player2._bid + player4._bid;
        scoreboardModal.setTeam2BidValue(player2and4Bid);
        let player1and3Tricks = player1._tricksTaken + player3._tricksTaken;
        scoreboardModal.setTeam1TricksValue(player1and3Tricks);
        let player2and4Tricks = player2._tricksTaken + player4._tricksTaken;
        scoreboardModal.setTeam2TricksValue(player2and4Tricks);
        let player1and3Sandbags = 0;
        let player2and4Sandbags = 0;

        if (player1._bid === 0) {
            if (player1._bid === player1._tricksTaken) {
                scoreboardModal.setPlayer1NilResult("+100");
                Player1AndPlayer3Score += 100;
            }
            else {
                scoreboardModal.setPlayer1NilResult("-100");
                Player1AndPlayer3Score -= 100;
            }
        }

        if (player3._bid === 0) {
            if (player3._bid === player3._tricksTaken) {
                scoreboardModal.setPlayer3NilResult("+100");
                Player1AndPlayer3Score += 100;
            }
            else {
                scoreboardModal.setPlayer3NilResult("-100");
                Player1AndPlayer3Score -= 100;
            }
        }

        if (player1and3Bid > player1and3Tricks) {
            let val = player1and3Bid * 10;
            scoreboardModal.setTeam1BidResultValue("-" + val);
            Player1AndPlayer3Score -= val;
        }
        if (player1and3Bid <= player1and3Tricks) {
            let val = player1and3Bid * 10;
            scoreboardModal.setTeam1BidResultValue("+" + val);
            Player1AndPlayer3Score += val;
        }
        if (player1and3Bid < player1and3Tricks) {
            player1and3Sandbags = (player1and3Tricks - player1and3Bid);
            scoreboardModal.setTeam1SandbagsTakenValue(player1and3Sandbags);
            Player1AndPlayer3Sandbags += player1and3Sandbags;
            if (Player1AndPlayer3Sandbags >= 10) {
                scoreboardModal.setTeam1SandbagPenaltyValue("-100");
                Player1AndPlayer3Sandbags -= 10;
                Player1AndPlayer3Score -= 100;
            }

            Player1AndPlayer3Score += player1and3Sandbags;
        }

        if (player2._bid === 0) {
            if (player2._bid === player2._tricksTaken) {
                scoreboardModal.setPlayer2NilResult("+100");
                Player2AndPlayer4Score += 100;
            }
            else {
                scoreboardModal.setPlayer2NilResult("-100");
                Player2AndPlayer4Score -= 100;
            }
        }

        if (player4._bid === 0) {
            if (player4._bid === player4._tricksTaken) {
                scoreboardModal.setPlayer4NilResult("+100");
                Player2AndPlayer4Score += 100;
            }
            else {
                scoreboardModal.setPlayer4NilResult("-100");
                Player2AndPlayer4Score -= 100;
            }
        }

        if (player2and4Bid > player2and4Tricks) {
            let val = player2and4Bid * 10;
            scoreboardModal.setTeam1BidResultValue(val);
            Player2AndPlayer4Score -= val;
        }
        if (player2and4Bid <= player2and4Tricks) {
            let val = player2and4Bid * 10;
            scoreboardModal.setTeam1BidResultValue(val);
            Player2AndPlayer4Score += val;
        }
        if (player2and4Bid < player2and4Tricks) {
            player2and4Sandbags = (player2and4Tricks - player2and4Bid);
            scoreboardModal.setTeam1SandbagsTakenValue(player2and4Sandbags);
            Player2AndPlayer4Sandbags += player2and4Sandbags;
            if (Player2AndPlayer4Sandbags >= 10) {
                scoreboardModal.setTeam1SandbagPenaltyValue("-100");
                Player2AndPlayer4Sandbags -= 10;
                Player2AndPlayer4Score -= 100;
            }

            Player2AndPlayer4Score += player2and4Sandbags;
        }

        scoreboardModal.setTeam1TotalScore(Player1AndPlayer3Score);
        scoreboardModal.setTeam1TotalSandbags(Player1AndPlayer3Sandbags);
        scoreboardModal.setTeam2TotalScore(Player2AndPlayer4Score);
        scoreboardModal.setTeam2TotalSandbags(Player2AndPlayer4Sandbags);

        Team1ScoreDiv.setInnerHtml(Player1AndPlayer3Score);
        Team2ScoreDiv.setInnerHtml(Player2AndPlayer4Score);
        Team1SandbagsDiv.setInnerHtml(Player1AndPlayer3Sandbags);
        Team2SandbagsDiv.setInnerHtml(Player2AndPlayer4Sandbags);

        let endGame = doesScoreEndGame(Player1AndPlayer3Score, Player2AndPlayer4Score, "Team 1", "Team 2");
        if (endGame === true) {
            scoreboardModal.updateModalButtonText("Finish");
            return true;
        }
        else {
            endGame = doesScoreEndGame(Player2AndPlayer4Score, Player1AndPlayer3Score, "Team 2", "Team 1");
            if (endGame === true) {
                scoreboardModal.updateModalButtonText("Finish");
                return true;
            }
        }

        //alert("Current game score: Team 1: " + Player1AndPlayer3Score + " and Team 2: " + Player2AndPlayer4Score);
        return false;
    }

    function doesScoreEndGame(firstTeamScore, secondTeamScore, firstTeamName, secondTeamName) {
        if (firstTeamScore >= maxScoreLimit) {
            if (secondTeamScore >= maxScoreLimit) {
                if (firstTeamScore === secondTeamScore) {
                    //alert("The game was a tie! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle("The game was a tie!");
                    return true;
                }
                else if (firstTeamScore > secondTeamScore) {
                    //alert(firstTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle(firstTeamName + " wins!");
                    return true;
                }
                else {
                    //alert(secondTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle(secondTeamName + " wins!");
                    return true;
                }
            }
            else {
                //alert(firstTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                scoreboardModal.updateScoreboardTitle(firstTeamName + " wins!");
                return true;
            }
        }
        if (firstTeamScore <= minScoreLimit) {
            if (secondTeamScore <= minScoreLimit) {
                if (firstTeamScore === secondTeamScore) {
                    //alert("The game was a tie! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle("The game was a tie!");
                    return true;
                }
                else if (firstTeamScore > secondTeamScore) {
                    //alert(firstTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle(firstTeamName + " wins!");
                    return true;
                }
                else {
                    //alert(secondTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                    scoreboardModal.updateScoreboardTitle(secondTeamName + " wins!");
                    return true;
                }
            }
            else {
                //alert(secondTeamName + " wins! " + firstTeamName + ": " + firstTeamScore + " and " + secondTeamName + ": " + secondTeamScore);
                scoreboardModal.updateScoreboardTitle(secondTeamName + " wins!");
                return true;
            }
        }
        return false;
    }

    function clearPlayAreaCards() {
        Player1CardDiv.setInnerHtml('');
        Player2CardDiv.setInnerHtml('');
        Player3CardDiv.setInnerHtml('');
        Player4CardDiv.setInnerHtml('');
    }

    function movePlayAreaCardsToWinner(winnerIndex) {
        switch (winnerIndex) {
            case 0:
                players[1]._playAreaDiv.setClassName("play-area-card down-right");
                players[2]._playAreaDiv.setClassName("play-area-card down");
                players[3]._playAreaDiv.setClassName("play-area-card down-left");
                break;
            case 1:
                players[0]._playAreaDiv.setClassName("play-area-card up-left");
                players[2]._playAreaDiv.setClassName("play-area-card down-left");
                players[3]._playAreaDiv.setClassName("play-area-card left");
                break;
            case 2:
                players[0]._playAreaDiv.setClassName("play-area-card up");
                players[1]._playAreaDiv.setClassName("play-area-card up-right");
                players[3]._playAreaDiv.setClassName("play-area-card up-left");
                break;
            case 3:
                players[0]._playAreaDiv.setClassName("play-area-card up-right");
                players[1]._playAreaDiv.setClassName("play-area-card right");
                players[2]._playAreaDiv.setClassName("play-area-card down-right");
                break;
            default:
                console.log("Winner index was invalid. Index was: " + winnerIndex);
        }
    }

    function setCurrentPlayerTurn(playerIndex) {
        players[0]._nameDiv.setColorWhite();
        players[1]._nameDiv.setColorWhite();
        players[2]._nameDiv.setColorWhite();
        players[3]._nameDiv.setColorWhite();
        currentPlayerTurn = playerIndex;
        players[playerIndex]._nameDiv.setColorGreen();
    }

    function startNewRound() {
        handlingPlayerClick = false;
        spadesBrokenThisGame = false;
        currentPlayedCards = [null, null, null, null];
        cardsPlayedThisRound = 0;
        highestCurrentRoundCard = null;
        totalHandsPlayed = 0;
        currentBidCount = 0;
        currentRoundSuit = null;
        PlayerBidInput.setValue("");
        PlayerBidContainerDiv.showBlock();
        let i = 0;
        for (i = 0; i < players.length; i++) {
            players[i].resetBidAndTricks();
        }
        dealNewHand();
        dealerIndex = getNextPlayer(dealerIndex);
        setCurrentPlayerTurn(getNextPlayer(dealerIndex));
        initiateBidding();
    }

    function resetGame() {
        handlingPlayerClick = false;
        endGame = false;
        Player1AndPlayer3Score = 0;
        Player1AndPlayer3Sandbags = 0;
        Player2AndPlayer4Score = 0;
        Player2AndPlayer4Sandbags = 0;
        Team1ScoreDiv.setInnerHtml(Player1AndPlayer3Score);
        Team2ScoreDiv.setInnerHtml(Player2AndPlayer4Score);
        Team1SandbagsDiv.setInnerHtml(Player1AndPlayer3Sandbags);
        Team2SandbagsDiv.setInnerHtml(Player2AndPlayer4Sandbags);

        dealerIndex = getRandomIntInclusive(0, 3);

        startNewRound();
    }

    function closeScoreboardModal() {
        scoreboardModal.hideScoreboard();
        scoreboardModal.hideAllConditionalDetails();
        scoreboardModal.resetScoreboardTitle();
        scoreboardModal.updateModalButtonText("Continue");
        if (endGame === true) {
            resetGame();
            return;
        }
        startNewRound();
        return;
    }

    function playerBidKeyupHandler(event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            submitBid();
        }
    }

    function sleep(milliseconds) {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
    }

    document.getElementById("playerCard0").addEventListener('click', function () { selectCard(0) });
    document.getElementById("playerCard1").addEventListener('click', function () { selectCard(1) });
    document.getElementById("playerCard2").addEventListener('click', function () { selectCard(2) });
    document.getElementById("playerCard3").addEventListener('click', function () { selectCard(3) });
    document.getElementById("playerCard4").addEventListener('click', function () { selectCard(4) });
    document.getElementById("playerCard5").addEventListener('click', function () { selectCard(5) });
    document.getElementById("playerCard6").addEventListener('click', function () { selectCard(6) });
    document.getElementById("playerCard7").addEventListener('click', function () { selectCard(7) });
    document.getElementById("playerCard8").addEventListener('click', function () { selectCard(8) });
    document.getElementById("playerCard9").addEventListener('click', function () { selectCard(9) });
    document.getElementById("playerCard10").addEventListener('click', function () { selectCard(10) });
    document.getElementById("playerCard11").addEventListener('click', function () { selectCard(11) });
    document.getElementById("playerCard12").addEventListener('click', function () { selectCard(12) });
    document.getElementById("PlayerBidInput").addEventListener('keyup', function (event) { playerBidKeyupHandler(event) });
    document.getElementById("PlayerBidSubmit").addEventListener('click', function () { submitBid() });
    document.getElementById("ModalContinue").addEventListener('click', function () { closeScoreboardModal() });

    document.getElementById("playerCard0").addEventListener('mouseover', function(e) {
        e.preventDefault();
        document.getElementById("SideInfo").style.display = "block";
    });

    document.getElementById("playerCard0").addEventListener('mouseout', function(e) {
        e.preventDefault();
        document.getElementById("SideInfo").style.display = "none";
    });

    // Main game:
    startGame();


</script>

</html>